/*
 * hal_debounce.c
 *
 *  Created on: Aug 14, 2023
 *      Author: jpieterick
 */

#include "pindefs.h"
#include <hal_debounce.h>
#include <stdint.h>
#include "hal_gpio.h"

#define DEBOUNCE_DEPTH (32) // This value must always be a power of 2.
#define DEBOUNCE_WRAP  (DEBOUNCE_DEPTH - 1) // binary 11111b in the case of depth == 16.

static uint32_t PortReadings[NumGPIOPorts][DEBOUNCE_DEPTH];

static uint32_t DebouncedReadings[NumGPIOPorts][2];

static uint8_t ThisReading = 0;

void HalDebounceReadAndDebounceInputs(void)
{
	  uint8_t thisPort;
	  	uint16_t i;

	// Now debounce the inputs by anding and oring the members of the readings array.
	for (thisPort = 0;NumGPIOPorts > thisPort; thisPort++)
	{
	   // Add this reading to the port readings array.
	   PortReadings[thisPort][ThisReading] = hal_gpio_read_port(thisPort);

	   DebouncedReadings[thisPort][0] = 0;
	   DebouncedReadings[thisPort][1] = 0xFFFFFFFF;

	   for (i = 0;DEBOUNCE_DEPTH > i;i++)
	   {
		   // debounce this port for input state == zero. If all members of the Port Readings array have a 0 in
		   // a specific bit position, that bit will be 0 in DebouncedLow for that port.
		   DebouncedReadings[thisPort][0] |= PortReadings[thisPort][i];

		   // debounce this port for input pin state == one. If all members of the Port Readings array have a 1 in
		   // a specific bit position, that bit will be 1 in DebouncedHigh for that port.
		   DebouncedReadings[thisPort][1] &= PortReadings[thisPort][i];
	   }

	}

	// Increment and wrap the reading number
	  ++ThisReading;
	  ThisReading &= DEBOUNCE_WRAP; // This will go back to zero when the value is incremented passed
									// the value of DEBOUNCE_WRAP.
}

// This function will return true if the specified pins state matches the indicated state.
bool HalDebounceCheckPinState(enum pin_id pinId,bool state2BeChecked)
{
	bool retVal = false;

	if (true == state2BeChecked)
	{
		// Check for a one on the specified pins bit.
		if((DebouncedReadings[pin_defs[pinId].PortId][1] & pin_defs[pinId].Pin) == pin_defs[pinId].Pin)
		{
			// This pins bit was set to one in all members of the PortReading array so return true:
			retVal = true;
		}
	}
	else
	{
		// Check for a zero on the specified pins bit.
		if((DebouncedReadings[pin_defs[pinId].PortId][0] & pin_defs[pinId].Pin) == 0)
		{
			// This pins bit was set to zero in all members of the PortReading array so return true:
			retVal = true;
		}
	}

	return retVal;
}
